<script>
  /**
   * Mixin that provides intl-format-locale and computes some separation strings for usage.
   *
   * @mixinFunction
   * @polymer
   *
   * @param {Object} superClass class to extend
   * @return {Object} extended class
   */
  const IntlFormatMixin = superClass => { // eslint-disable-line no-unused-vars no-undef

    return class extends superClass {

      static get properties() {
        return {
          /**
           * The current locale
           */
          locale: {
            type: String,
            value: window.navigator.language
          },

          /**
           * The formated and used locale
           */
          _locale: {
            type: String
          },

          /**
           * Numbering system. Possible values include: "arab", "arabext", "bali", "beng", "deva", "fullwide", "gujr", "guru", "hanidec", "khmr", "knda", "laoo", "latn", "limb", "mlym", "mong", "mymr", "orya", "tamldec", "telu", "thai", "tibt".
           */
          numberingSystem: {
            type: String,
            value: 'latn'
          },

          /**
           * Calendar. Possible values include: "buddhist", "chinese", "coptic", "ethioaa", "ethiopic", "gregory", "hebrew", "indian", "islamic", "islamicc", "iso8601", "japanese", "persian", "roc"
           */
          calendar: {
            type: String,
            value: 'iso8601'
          },

          /**
           * Separator for local date values (date-string is still in ISO-Format)
           * @type {string}
           */
          dateSeparator: {
            type: String,
            value: '-'
          },

          /**
           * Separator for local time values (time-string is still in ISO-Format)
           * @type {string}
           */
          timeSeparator: {
            type: String,
            value: ':'
          },

          /**
           * Separator for local decimal values
           * @type {string}
           */
          decimalSeparator: {
            type: String,
            value: '.'
          },

          /**
           * locale representation of 'AM'
           */
          amString: {
            type: String
          },

          /**
           * locale representation of 'PM'
           */
          pmString: {
            type: String
          }
        }
      }

      static get observers() {
        return [
          '_localeChanged(locale, numberingSystem, calendar)'
        ]
      }

      _localeChanged(locale, numberingSystem, calendar) {
        if (!(locale && Intl.NumberFormat && Intl.NumberFormat.supportedLocalesOf(locale) && Intl.DateTimeFormat && Intl.DateTimeFormat.supportedLocalesOf(locale))) {
          this.locale = window.navigator.language;
          return;
        }
        // test whether the locale contains a calendar or number system
        let pos, next, hasNumbersystem;
        // test for numbering system
        if (locale.indexOf('-u-') !== -1) {
          if ((pos = locale.indexOf('-nu-')) !== -1) {
            pos += 4;
            next = locale.indexOf('-', pos);

            if (next === -1) {
              numberingSystem = locale.slice(pos);
            } else {
              numberingSystem = locale.slice(pos, next);
            }

            if (numberingSystem !== this.numberingSystem) {
              this.numberingSystem = numberingSystem;
              return;
            }
          } else {
            locale += '-nu-' + numberingSystem;
          }
          // test for calendar
          if ((pos = locale.indexOf('-ca-')) !== -1) {
            pos += 4;
            next = locale.indexOf('-', pos);

            if (next === -1) {
              calendar = locale.slice(pos);
            } else {
              calendar = locale.slice(pos, next);
            }

            if (calendar !== this.calendar) {
              this.calendar = calendar;
              return;
            }
          } else {
            locale += '-ca-' + calendar;
          }
        }

        locale = (((pos = locale.indexOf('-u-')) === -1) ? locale : locale.slice(0, pos)) + '-u-nu-' + (numberingSystem || 'latn') + '-ca-' + (calendar || 'iso8601');

        // test if locale is valid
        try {
          const test = new Intl.NumberFormat(locale);
        } catch (e) {
          console.warn(e);
          // fallback to default
          locale = (((pos = locale.indexOf('-u-')) === -1) ? locale : locale.slice(0, pos)) + '-u-nu-latn-ca-iso8601';
        }
        this._locale = locale;

        // decimal separator
        const numbers = [1, 2];
        const formatedNumbers = numbers.map( p => {
          return numberFormat(p)
        });
        const decimalSeparator = formatedNumbers.reduce( (acc, currentValue) => {
          return acc.replace(currentValue, '');
        }, numberFormat.format(1.2));

        // date separator
        let d = new Date(Date.UTC(1970, 0, 22, 11, 44, 55));

        // create datestring in locale format
        const formatedDateParts = [
          d.toLocaleDateString(locale, { month: '2-digit', timeZone: 'UTC', hour12: false }).slice(0, 2),
          d.toLocaleDateString(locale, { day: '2-digit', timeZone: 'UTC', hour12: false }).slice(0, 2)
        ];
        // using UTC-timezone to avoid conflicts when comparing
        const dateSeparator = formatedDateParts.reduce( (acc, currentValue) => {
          return acc.replace(currentValue, '');
        }, d.toLocaleDateString(locale, { month: '2-digit', day: '2-digit', timeZone: 'UTC', hour12: false })).slice(0, 1);

        // time separator
        // create datestring in locale format
        const formatedTimeParts = [
          d.toLocaleTimeString(locale, { hour: '2-digit', timeZone: 'UTC', hour12: false }).slice(0, 2),
          d.toLocaleTimeString(locale, { minutes: '2-digit', timeZone: 'UTC', hour12: false }).slice(0, 2)
        ];
        // using UTC-timezone to avoid conflicts when comparing
        const timeSeparator = formatedTimeParts.reduce( (acc, currentValue) => {
          return acc.replace(currentValue, '');
        }, d.toLocaleTimeString(locale, { hour: '2-digit', minutes: '2-digit', timeZone: 'UTC', hour12: false } )).slice(0, 1);

        // am-pm strings
        formatedTimeParts.push(timeSeparator);

        // am
        const amString = formatedTimeParts.reduce( (acc, currentValue) => {
          return acc.replace(currentValue, '');
        }, d.toLocaleTimeString(locale, { hour: '2-digit', minutes: '2-digit', timeZone: 'UTC', hour12: true } ));

        // pm
        d.setUTCHours(16);
        formatedTimeParts[0] = d.toLocaleTimeString(locale, { hour: '2-digit', timeZone: 'UTC', hour12: false }).slice(0, 2);
        const pmString = formatedTimeParts.reduce( (acc, currentValue) => {
          return acc.replace(currentValue, '');
        }, d.toLocaleTimeString(locale, { hour: '2-digit', minutes: '2-digit', timeZone: 'UTC', hour12: true } ));

        this.setProperties({
          numberFormat: numberFormat,
          datetimeFormat: datetimeFormat,
          dateSeparator: dateSeparator,
          timeSeparator: timeSeparator,
          decimalSeparator: decimalSeparator,
          amString: (!amString || amString === '.') ? 'AM' : amString, // IE fix for languages that usually don't use am-pm suffixes
          pmString: (!pmString || pmString === '.') ? 'PM' : pmString
        });
      }
    }
  }

  window.IntlFormatMixin = IntlFormatMixin;
</script>
