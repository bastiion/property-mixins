<script>
  /**
   * Mixin that provides intl-format and -parse functions for numbers and dates and computes some separation strings for usage.
   *
   * @mixinFunction
   * @polymer
   *
   * @param {Object} superClass class to extend
   * @return {Object} extended class
   */
  const IntlFormatMixin = (superClass) => { // eslint-disable-line no-unused-vars no-undef

    return class extends superClass {

      static get properties() {
        return {
          /**
           * The current locale
           */
          locale: {
            type: String,
            value: window.navigator.language
          },

          /**
           * The formated and used locale
           */
          _locale: {
            type: String
          },

          /**
           * Numbering system. Possible values include: "arab", "arabext", "bali", "beng", "deva", "fullwide", "gujr", "guru", "hanidec", "khmr", "knda", "laoo", "latn", "limb", "mlym", "mong", "mymr", "orya", "tamldec", "telu", "thai", "tibt".
           */
          numberingSystem: {
            type: String,
            value: 'latn'
          },

          /**
           * Calendar. Possible values include: "buddhist", "chinese", "coptic", "ethioaa", "ethiopic", "gregory", "hebrew", "indian", "islamic", "islamicc", "iso8601", "japanese", "persian", "roc"
           */
          calendar: {
            type: String,
            value: 'iso8601'
          },

          /**
           * Separator for local date values (date-string is still in ISO-Format)
           * @type {string}
           */
          dateSeparator: {
            type: String,
            value: '-'
          },

          /**
           * Separator for local time values (time-string is still in ISO-Format)
           * @type {string}
           */
          timeSeparator: {
            type: String,
            value: ':'
          },

          /**
           * Separator for local decimal values
           * @type {string}
           */
          decimalSeparator: {
            type: String,
            value: '.'
          },

          /**
           * locale representation of 'AM'
           */
          amString: {
            type: String
          },

          /**
           * locale representation of 'PM'
           */
          pmString: {
            type: String
          },

          /**
           * intl-numberformat-object according to the given locale and options
           */
          numberFormat: {
            type: Object
          },

          /**
           * intl-datetimeformat-object according to the given locale and options
           */
          datetimeFormat: {
            type: Object
          },

          /**
           * number format options
           */
          numberOptions: {
            type: Object,
            value: function() {
              return {
                useGrouping: false
              }
            }
          },

          /**
           * datetime format options
           */
          datetimeOptions: {
            type: Object,
            value: function() {
              return {};
            }
          }
        }
      }

      static get observers() {
        return [
          '_localeChanged(locale, numberingSystem, calendar)',
          '_numberOptionsChanged(numberOptions)',
          '_datetimeOptionsChanged(datetimeOptions)'
        ]
      }

      _localeChanged(locale, numberingSystem, calendar) {
        if (!locale) {
          this.locale = window.navigator.language;
          return;
        }
        // test whether the locale contains a calendar or number system
        let pos, next, hasNumbersystem;
        // test for numbering system
        if (locale.indexOf('-u-') !== -1) {
          if ((pos = locale.indexOf('-nu-')) !== -1) {
            pos += 4;
            next = locale.indexOf('-', pos);

            if (next === -1) {
              numberingSystem = locale.slice(pos);
            } else {
              numberingSystem = locale.slice(pos, next);
            }

            if (numberingSystem !== this.numberingSystem) {
              this.numberingSystem = numberingSystem;
              return;
            }
          } else {
            locale += '-nu-' + numberingSystem;
          }
          // test for calendar
          if ((pos = locale.indexOf('-ca-')) !== -1) {
            pos += 4;
            next = locale.indexOf('-', pos);

            if (next === -1) {
              calendar = locale.slice(pos);
            } else {
              calendar = locale.slice(pos, next);
            }

            if (calendar !== this.calendar) {
              this.calendar = calendar;
              return;
            }
          } else {
            locale += '-ca-' + calendar;
          }
        }

        locale = (((pos = locale.indexOf('-u-')) === -1) ? locale : locale.slice(0, pos)) + '-u-nu-' + (numberingSystem || 'latn') + '-ca-' + (calendar || 'iso8601');

        // test if locale is valid
        try {
          const test = new Intl.NumberFormat(locale);
        } catch (e) {
          console.warn(e);
          // fallback to default
          locale = this._locale = (((pos = locale.indexOf('-u-')) === -1) ? locale : locale.slice(0, pos)) + '-u-nu-latn-ca-iso8601';
        }

        const numberFormat = new Intl.NumberFormat(locale, this.numberOptions || {});
        const datetimeFormat = new Intl.DateTimeFormat(locale, this.datetimeOptions || {});

        // decimal separator
        const numbers = [1, 2];
        const formatedNumbers = numbers.map(numberFormat.format);
        const decimalSeparator = formatedNumbers.reduce( (acc, currentValue) => {
          return acc.replace(currentValue, '');
        }, numberFormat.format(1.2));

        // date separator
        // create datestring in locale format
        const dateParts = [1970, 10];
        const formatedDateParts = dateParts.map(numberFormat.format);
        // using UTC-timezone to avoid conflicts when comparing
        const dateSeparator = formatedDateParts.reduce( (acc, currentValue) => {
          return acc.replace(currentValue, '');
        }, (new Date(Date.UTC.apply(null, dateParts))).toLocaleDateString(locale, {
          year: 'numeric',
          month: 'numeric',
          timeZone: 'UTC',
          hour12: false
        }));

        // date separator
        // create datestring in locale format
        let timeParts = [8, 10];
        let formatedTimeParts = timeParts.map(numberFormat.format);
        // using UTC-timezone to avoid conflicts when comparing
        const timeSeparator = formatedTimeParts.reduce( (acc, currentValue) => {
          return acc.replace(currentValue, '');
        }, (new Date(Date.UTC(1970,0,1,8,10))).toLocaleTimeString(locale, {
          hour: 'numeric',
          minute: 'numeric',
          timeZone: 'UTC',
          hour12: false
        }));

        // am-pm strings
        formatedTimeParts.push(timeSeparator);

        // am
        const amString = formatedTimeParts.reduce( (acc, currentValue) => {
          return acc.replace(currentValue, '');
        }, (new Date(Date.UTC(1970,0,1,8,10))).toLocaleTimeString(locale, {
          hour: 'numeric',
          minute: 'numeric',
          timeZone: 'UTC',
          hour12: true
        }));

        // pm
        formatedTimeParts[0] = numberFormat.format(16);
        const pmString = formatedTimeParts.reduce( (acc, currentValue) => {
          return acc.replace(currentValue, '');
        }, (new Date(Date.UTC(1970,0,1,16,10))).toLocaleTimeString(locale, {
          hour: 'numeric',
          minute: 'numeric',
          timeZone: 'UTC',
          hour12: true
        }));

        this.setProperties({
          numberFormat: numberFormat,
          datetimeFormat: datetimeFormat,
          dateSeparator: dateSeparator,
          timeSeparator: timeSeparator,
          decimalSeparator: decimalSeparator,
          amString: amString === '.' ? 'AM' : amString, // IE fix for languages that usually don't use am-pm suffixes
          pmString: pmString === '.' ? 'PM' : pmString
        });
      }

      _numberOptionsChanged(numberOptions) {
        if (this._locale === undefined || numberOptions === undefined) {
          return;
        }
        this.set('numberFormat', new Intl.NumberFormat(this._locale, numberOptions))
      }

      _datetimeOptionsChanged(datetimeOptions) {
        if (this._locale === undefined || datetimeOptions === undefined) {
          return;
        }
        this.set('datetimeFormat', new Intl.DateTimeFormat(this._locale, datetimeOptions))
      }

    }
  }

  window.IntlFormatMixin = IntlFormatMixin;
</script>
